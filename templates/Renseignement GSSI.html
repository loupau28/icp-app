<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GSSI</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: url('/static/FOND.png') no-repeat center center fixed;
      background-size: cover;
      padding: 20px;
      color: red;
    }
    table {
      border-collapse: collapse;
      margin-top: 20px;
      width: 100%;
      min-width: 700px;
    }
    th, td {
      border: 2px solid black;
      padding: 10px;
      text-align: center;
    }
    td {
      background-color: #f2f2f2;
    }
    input, button, select {
      margin: 10px 0;
      padding: 10px;
      font-size: 16px;
    }
    label {
      font-weight: bold;
      margin-right: 10px;
    }
    #tableau-container {
      width: 100%;
      overflow-x: auto;
    }
    #send-button {
      display: none;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h2>RENSEIGNEMENT DES GSSI</h2>

  <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
    <label for="SOG-select">Nom du SOG :</label>
    <select id="SOG-select">
      <option value="">Sélectionnez</option>
      <option value="ADC CRETIN">ADC CRETIN</option>
      <option value="ADC VITTET">ADC VITTET</option>
      <option value="ADC DETAILLE">ADC DETAILLE</option>
      <option value="ADC POUSSIN">ADC POUSSIN</option>
      <option value="ADC GAUDET">ADC GAUDET</option>
      <option value="ADC TRAVERT">ADC TRAVERT</option>
    </select>

    <label for="nombre">Nombre d’agents :</label>
    <input type="number" id="nombre" min="1" max="12" />

    <button id="generer-btn">Générer le tableau</button>
  </div>

  <div id="tableau-container"></div>

  <div id="send-button">
    <button onclick="envoyerGSSIetSauvegarder()">ENVOYER GSSI</button>
    <button onclick="window.location.href='/'">RETOUR</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>
    emailjs.init("ZJ5lL9lyhjYLHetb8");

    async function genererTableau() {
  const container = document.getElementById('tableau-container');
  const nombre = parseInt(document.getElementById('nombre').value);
  const colonnes = ["NOM","FEU PSC SOUS ARI", "ECHELLE A CROCHET", "SAUVETAGE EN EXCAVATION"];
  if (isNaN(nombre) || nombre < 1 || nombre > 12) return;

  let html = "<table><thead><tr>";
  colonnes.forEach(col => html += `<th>${col}</th>`);
  html += "</tr></thead><tbody>";

  for (let i = 0; i < nombre; i++) {
    html += "<tr>";
    colonnes.forEach((col, j) => {
      if (j === 0) {
        html += `<td><input type="text" class="nom-cell" spellcheck="false" style="width: 100%;"></td>`;
      } else {
        html += `<td><input type="checkbox"/></td>`;
      }
    });
    html += "</tr>";
  }
  html += "</tbody></table>";

  container.innerHTML = html;
  document.getElementById('send-button').style.display = 'block';

  const nomInputs = container.querySelectorAll('.nom-cell');
  nomInputs.forEach(input => {
    input.addEventListener('input', () => {
      const start = input.selectionStart;
      const end = input.selectionEnd;
      input.value = input.value.toUpperCase();  // Majuscules
      input.setSelectionRange(start, end);      // Maintient la position du curseur
    });

    input.addEventListener('focus', () => {
      setTimeout(() => {
        const rect = input.getBoundingClientRect();
        const offset = window.pageYOffset + rect.top - 100;
        window.scrollTo({ top: offset, behavior: 'smooth' });
      }, 200);
    });
  });

  // Préremplir anciens résultats
  const eap = document.getElementById("SOG-select").value;
  if (!eap) return;
  try {
    const res = await fetch(`/get-gssi?eap=${encodeURIComponent(eap)}`);
    if (res.ok) {
      const anciens = await res.json();
      const rows = container.querySelectorAll('tbody tr');
      rows.forEach(row => {
        const nomInput = row.querySelector('.nom-cell');
        const nom = nomInput.value.trim().toUpperCase();
        const ancien = anciens.find(a => a.nom.toUpperCase() === nom);
        if (ancien) {
          row.cells[1].querySelector("input").checked = ancien.psc === 1;
          row.cells[2].querySelector("input").checked = ancien.crochet === 1;
          row.cells[3].querySelector("input").checked = ancien.excavation === 1;
        }
      });
    }
  } catch (err) {
    console.error("Erreur récupération anciens résultats :", err);
  }
}

document.getElementById("generer-btn").addEventListener("click", genererTableau);

function ajouterStylesTable(table) {
  table.style.borderCollapse = "collapse";
  table.style.width = "100%";
  table.querySelectorAll("th").forEach(th => {
    th.style.border = "2px solid black";
    th.style.padding = "10px";
    th.style.textAlign = "center";
    th.style.backgroundColor = "#f2f2f2";
  });
  table.querySelectorAll("td").forEach(td => {
    td.style.border = "2px solid black";
    td.style.padding = "10px";
    td.style.textAlign = "center";
    td.style.backgroundColor = "#f2f2f2";
  });
  return table.outerHTML;
}


    async function envoyerGSSIetSauvegarder() {
      const eap = document.getElementById("SOG-select").value;
      const table = document.querySelector("table");
      const rows = document.querySelectorAll("tbody tr");
      const agents = [];

      rows.forEach(row => {
        const cells = row.querySelectorAll("td");
        const nom = cells[0].querySelector('input').value.trim();
        const psc = cells[1].querySelector("input")?.checked ? 1 : 0;
        const crochet = cells[2].querySelector("input")?.checked ? 1 : 0;
        const excavation = cells[3].querySelector("input")?.checked ? 1 : 0;
        agents.push({ nom, psc, crochet, excavation });
        cells[1].innerText = psc ? "Oui" : "Non";
        cells[2].innerText = crochet ? "Oui" : "Non";
        cells[3].innerText = excavation ? "Oui" : "Non";
      });

      let anciensResultats = {};
      try {
        const res = await fetch(`/get-gssi?eap=${encodeURIComponent(eap)}`);
        if (res.ok) {
          const data = await res.json();
          data.forEach(agent => {
            anciensResultats[agent.nom.toUpperCase()] = agent;
          });
        }
      } catch (err) {
        console.error("Erreur récupération anciens résultats :", err);
      }

      const agentsFusionnes = agents.map(agent => {
        const ancien = anciensResultats[agent.nom.toUpperCase()] || {};
        return {
          nom: agent.nom,
          psc: agent.psc || ancien.psc || 0,
          crochet: agent.crochet || ancien.crochet || 0,
          excavation: agent.excavation || ancien.excavation || 0
        };
      });

      const tableClone = table.cloneNode(true);
      const tableHTML = ajouterStylesTable(tableClone);

      const destinataires = [
        "florent.skirlo@sdis95.fr",
       "louisthom2810@gmail.com"
      ];

      destinataires.forEach(email => {
        emailjs.send("SOGTAV", "ENVOIEICPGSSI", {
          to_email: email,
          eap_name: eap,
          table_html: tableHTML,
          date_envoi: new Date().toLocaleDateString("fr-FR"),
          type_resultat: "GSSI",
          agents: JSON.stringify(agentsFusionnes)
        }).then(() => {
          console.log(`Email GSSI envoyé à ${email} !`);
        }).catch(err => {
          console.error("Erreur d'envoi email : " + err.text);
        });
      });

      fetch(`/save-gssi`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          eap: eap,
          date: new Date().toISOString().slice(0, 10),
          agents: agentsFusionnes
        })
      })
      .then(res => res.json())
      .then(data => console.log("Sauvegarde OK :", data))
      .catch(err => console.error("Erreur de sauvegarde :", err));
    }
  </script>
</body>
</html>
