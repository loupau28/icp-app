<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GSSI</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: url('/static/FOND.png') no-repeat center center fixed;
      background-size: cover;
      padding: 20px;
      color: red;
    }
    table {
      border-collapse: collapse;
      margin-top: 20px;
      width: 100%;
      min-width: 700px;
    }
    th, td {
      border: 2px solid black;
      padding: 10px;
      text-align: center;
      background-color: #f2f2f2;
    }
    input, button, select {
      margin: 10px 0;
      padding: 10px;
      font-size: 16px;
    }
    label {
      font-weight: bold;
      margin-right: 10px;
    }
    #tableau-container {
      width: 100%;
      overflow-x: auto;
    }
    #send-button {
      display: none;
      margin-top: 20px;
    }
    /* Popup notification */
    #notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 25px;
      border-radius: 8px;
      font-weight: bold;
      color: white;
      display: none;
      z-index: 2000;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    #notification.success { background-color: #28a745; }
    #notification.error { background-color: #dc3545; }
    /* Loader overlay */
    #loader {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1500;
      display: none;
      color: white;
      font-size: 18px;
      font-weight: bold;
    }
    .spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h2>RENSEIGNEMENT DES GSSI</h2>

  <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
    <label for="SOG-select">Nom du SOG :</label>
    <select id="SOG-select">
      <option value="">Sélectionnez</option>
      <option value="ADC CRETIN">ADC CRETIN</option>
      <option value="ADC VITTET">ADC VITTET</option>
      <option value="ADC DETAILLE">ADC DETAILLE</option>
      <option value="ADC POUSSIN">ADC POUSSIN</option>
      <option value="ADC GAUDET">ADC GAUDET</option>
      <option value="ADC TRAVERT">ADC TRAVERT</option>
    </select>

    <label for="nombre">Nombre d’agents :</label>
    <input type="number" id="nombre" min="1" max="12" />

    <button id="generer-btn">Générer le tableau</button>
  </div>

  <div id="tableau-container"></div>

  <div id="send-button">
    <button id="envoyer-btn" onclick="envoyerGSSIetSauvegarder()">ENVOYER GSSI</button>
    <button onclick="window.location.href='/'">RETOUR</button>
  </div>

  <!-- Notification -->
  <div id="notification"></div>

  <!-- Loader avec texte -->
  <div id="loader">
    <div class="spinner"></div>
    <div>Envoi en cours...</div>
  </div>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>
    emailjs.init("ZJ5lL9lyhjYLHetb8");

    function showNotification(message, type="success") {
      const notif = document.getElementById("notification");
      notif.textContent = message;
      notif.className = type === "success" ? "success" : "error";
      notif.style.display = "block";
      setTimeout(() => { notif.style.display = "none"; }, 4000);
    }

    function toggleLoader(show) {
      document.getElementById("loader").style.display = show ? "flex" : "none";
      document.getElementById("envoyer-btn").disabled = show;
    }

    async function genererTableau() {
      const container = document.getElementById('tableau-container');
      const nombre = parseInt(document.getElementById('nombre').value);
      const colonnes = ["NOM","FEU PSC SOUS ARI", "ECHELLE A CROCHET", "SAUVETAGE EN EXCAVATION"];
      if (isNaN(nombre) || nombre < 1 || nombre > 12) return;

      const sog = document.getElementById("SOG-select").value;
      if (!sog) return;

      let anciens = [];
      try {
        const res = await fetch(`/get-gssi?sog=${encodeURIComponent(sog)}`);
        if (res.ok) anciens = await res.json();
      } catch (err) { console.error("Erreur récupération anciens résultats :", err); }

      let html = "<table><thead><tr>";
      colonnes.forEach(col => { html += `<th>${col}</th>`; });
      html += "</tr></thead><tbody>";

      for (let i = 0; i < Math.max(nombre, anciens.length); i++) {
        const agent = anciens[i] || {};
        html += "<tr>";
        html += `<td><input type="text" spellcheck="false" style="width:100%;" value="${agent.nom || ''}"></td>`;
        html += `<td><input type="checkbox" ${agent.psc ? 'checked' : ''}></td>`;
        html += `<td><input type="checkbox" ${agent.crochet ? 'checked' : ''}></td>`;
        html += `<td><input type="checkbox" ${agent.excavation ? 'checked' : ''}></td>`;
        html += "</tr>";
      }

      html += "</tbody></table>";
      container.innerHTML = html;
      document.getElementById('send-button').style.display = 'block';
    }

    document.getElementById("generer-btn").addEventListener("click", genererTableau);

    async function envoyerGSSIetSauvegarder() {
      const sog = document.getElementById("SOG-select").value;
      if (!sog) { showNotification("Veuillez sélectionner un SOG !","error"); return; }

      const table = document.querySelector("table");
      if (!table) { showNotification("Aucun tableau généré !","error"); return; }

      const rows = table.querySelectorAll("tbody tr");
      const agents = [];

      toggleLoader(true);

      const tableClone = table.cloneNode(true);
      tableClone.querySelectorAll("tbody tr").forEach((row, i) => {
        const cellsOriginal = rows[i].querySelectorAll("td");
        const cellsClone = row.querySelectorAll("td");

        cellsClone.forEach((cell, idx) => {
          const input = cellsOriginal[idx].querySelector("input");
          if (input) {
            cell.textContent = input.type === "checkbox" ? (input.checked ? "Oui" : "Non") : input.value.trim();
          }
        });

        agents.push({
          sog: sog,
          date: new Date().toISOString().split("T")[0],
          nom: cellsOriginal[0].querySelector("input").value.trim(),
          psc: cellsOriginal[1].querySelector("input").checked ? 1 : 0,
          crochet: cellsOriginal[2].querySelector("input").checked ? 1 : 0,
          excavation: cellsOriginal[3].querySelector("input").checked ? 1 : 0
        });
      });

      // Fusion doublons
      const merged = {};
      agents.forEach(a => {
        if (!merged[a.nom]) merged[a.nom] = { ...a };
        else {
          if (a.date > merged[a.nom].date) { merged[a.nom].date = a.date; merged[a.nom].sog = a.sog; }
          merged[a.nom].psc = merged[a.nom].psc || a.psc;
          merged[a.nom].crochet = merged[a.nom].crochet || a.crochet;
          merged[a.nom].excavation = merged[a.nom].excavation || a.excavation;
        }
      });
      const agentsFusionnes = Object.values(merged);

      function ajouterStylesTable(table) {
        table.style.borderCollapse = "collapse";
        table.style.width = "100%";
        table.querySelectorAll("th, td").forEach(cell => {
          cell.style.border = "2px solid black";
          cell.style.padding = "10px";
          cell.style.textAlign = "center";
          cell.style.backgroundColor = "#f2f2f2";
        });
        return table.outerHTML;
      }
      const tableHTML = ajouterStylesTable(tableClone);

      const today = new Date();
      const todayISO = today.toISOString().split("T")[0];
      const todayFR = today.toLocaleDateString("fr-FR");

      const emailData = {
        to_email: "florent.skirlo@sdis95.fr, louisthom2810@gmail.com",
        sog: sog,
		eap_name: "",
        message_html: tableHTML,
        date_envoi: todayFR,
        type_resultat: "GSSI"
      };

      try {
        await emailjs.send("SOGTAV", "ENVOIEICPGSSI", emailData);
        showNotification("✅ Email envoyé avec succès !","success");
      } catch (err) {
        console.error("Erreur EmailJS :", err);
        showNotification("❌ Erreur lors de l'envoi du mail.","error");
        toggleLoader(false);
        return;
      }

      try {
        const res = await fetch("/save-gssi", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ eap: sog, date: todayISO, agents: agentsFusionnes })
        });
        const data = await res.json();
        if (data.status === "ok") {
          showNotification("✅ Données sauvegardées avec succès !","success");
          setTimeout(() => { window.location.href = "/"; }, 1500);
        } else {
          showNotification("❌ Erreur lors de la sauvegarde.","error");
        }
      } catch (err) {
        console.error("Erreur fetch :", err);
        showNotification("❌ Erreur lors de la sauvegarde.","error");
      }

      toggleLoader(false);
    }
  </script>
</body>
</html>
