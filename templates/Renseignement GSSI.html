<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GSSI</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: url('/static/fond2.png') no-repeat center center fixed;
  background-size: cover; /* rempli l'√©cran */
  padding: 20px;
  color: red;
  margin: 0;
}

/* Ajustements pour petits √©crans (smartphones) */
@media (max-width: 768px) {
  body {
    background-size: contain; /* image enti√®rement visible sans d√©coupe */
    padding: 10px;
    color: red;
  }

  table {
    font-size: 14px; /* texte plus petit pour s'adapter */
  }

  input, button, select {
    font-size: 14px;
    padding: 8px;
  }
}

/* Table et cellules */
table {
  border-collapse: collapse;
  margin-top: 20px;
  width: 100%;
}
th, td {
  border: 2px solid black;
  padding: 10px;
  text-align: center;
}
td {
  background-color: #f2f2f2;
}
td[contenteditable="true"] {
  background-color: #fff;
}

label {
  font-weight: bold;
  margin-right: 10px;
}

#send-button {
  display: none;
  margin-top: 20px;
}
</style>

</head>
<body>
  <h2>RENSEIGNEMENT DES GSSI</h2>

  <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
    <label for="SOG-select">Nom du SOG :</label>
    <select id="SOG-select">
      <option value="">S√©lectionnez</option>
        <option value="ADC CRETIN">ADC CRETIN </option>
        <option value="ADC VITTET">ADC VITTET</option>
        <option value="ADC DETAILLE">ADC DETAILLE</option>
		<option value="ADC POUSSIN">ADC POUSSIN</option>
	    <option value="ADC GAUDET">ADC GAUDET</option>
		<option value="ADC TRAVERT">ADC TRAVERT</option>
    </select>

    <label for="nombre">Nombre d‚Äôagents :</label>
    <input type="number" id="nombre" min="1" max="12" />

    <button onclick="genererTableau()">G√©n√©rer le tableau</button>
  </div>

  <div id="tableau-container"></div>
  <div id="send-button">
    <button onclick="envoyerEmailEtSauvegarder('GSSI')">ENVOYER GSSI</button>
	<button onclick="window.location.href='/'">RETOUR</button>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>
    emailjs.init("ZJ5lL9lyhjYLHetb8");

function genererTableau() {
  const container = document.getElementById('tableau-container');
  const nombre = parseInt(document.getElementById('nombre').value);
  const colonnes = ["NOM","FEU PSC SOUS ARI", "ECHELLE A CROCHET", "SAUVETAGE EN EXCAVATION"];
  if (isNaN(nombre) || nombre < 1 || nombre > 12) return;

  let html = "<table><thead><tr>";
  colonnes.forEach(col => html += `<th>${col}</th>`);
  html += "</tr></thead><tbody>";

  for (let i = 0; i < nombre; i++) {
    html += "<tr>";
    colonnes.forEach((col, j) => {
      if (j === 0) {
        html += `<td contenteditable="true"></td>`;
      } else {
        html += `<td><input type="checkbox"/></td>`;
      }
    });
    html += "</tr>";
  }
  html += "</tbody></table>";
  container.innerHTML = html;
  document.getElementById('send-button').style.display = 'block';
}

function ajouterStylesTable(table) {
  table.style.borderCollapse = "collapse";
  table.style.width = "100%";
  table.querySelectorAll("th").forEach(th => {
    th.style.border = "2px solid black";
    th.style.padding = "10px";
    th.style.textAlign = "center";
    th.style.backgroundColor = "#f2f2f2";
  });
  table.querySelectorAll("td").forEach(td => {
    td.style.border = "2px solid black";
    td.style.padding = "10px";
    td.style.textAlign = "center";
    td.style.backgroundColor = "#f2f2f2";
  });
  return table.outerHTML;
}

function envoyerEmailEtSauvegarder(type) {
  const eap = document.getElementById("SOG-select").value;
  const table = document.querySelector("table");
  const rows = document.querySelectorAll("tbody tr");

  const agents = [];

  rows.forEach(row => {
    const cells = row.querySelectorAll("td");
    const nom = cells[0].innerText.trim();
    const psc = cells[1].querySelector("input")?.checked ? 1 : 0;
    const crochet = cells[2].querySelector("input")?.checked ? 1 : 0;
    const excavation = cells[3].querySelector("input")?.checked ? 1 : 0;

    agents.push({ nom, psc, crochet, excavation });

    cells[1].innerText = psc ? "Oui" : "Non";
    cells[2].innerText = crochet ? "Oui" : "Non";
    cells[3].innerText = excavation ? "Oui" : "Non";
  });

  const tableClone = table.cloneNode(true);
  const tableHTML = ajouterStylesTable(tableClone);

  emailjs.send("SOGTAV", "ENVOIEICPGSSI", {
    eap_name: eap,
    table_html: tableHTML,
    date_envoi: new Date().toLocaleDateString("fr-FR"),
    type_resultat: type
  }).then(() => {
    alert(`Email ${type} envoy√© !`);
  }).catch(err => {
    alert("Erreur d'envoi email : " + err.text);
  });

  // üîπ Correct fetch avec then/catch
  fetch(`/save-${type.toLowerCase()}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      eap: eap,
      date: new Date().toISOString().slice(0, 10),
      agents: agents
    })
  })
  .then(res => res.json())
  .then(data => {
    console.log("Sauvegarde OK :", data);
  })
  .catch(err => {
    console.error("Erreur de sauvegarde :", err);
  });
}

</script>

</body>
</html>
